name: VerificaÃ§Ã£o AutomÃ¡tica de Qualidade

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    name: VerificaÃ§Ã£o de Qualidade de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Instalar dependÃªncias
        run: npm ci

      - name: ESLint com regras de seguranÃ§a
        run: npm run lint:security

      - name: VerificaÃ§Ã£o TypeScript
        run: npm run check

      - name: AnÃ¡lise de vulnerabilidades
        run: npm audit --audit-level=high

      - name: VerificaÃ§Ã£o automÃ¡tica de qualidade
        run: npm run quality:check

      - name: AnÃ¡lise de complexidade ciclomÃ¡tica
        run: npm run quality:complexity

      - name: DetecÃ§Ã£o de cÃ³digo duplicado
        run: npm run quality:duplicates

      - name: Upload relatÃ³rios de qualidade
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-reports
          path: reports/

      - name: Comentar PR com resultados
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Ler relatÃ³rio de qualidade se existir
            const reportsDir = 'reports/quality';
            if (fs.existsSync(reportsDir)) {
              const files = fs.readdirSync(reportsDir);
              const latestReport = files
                .filter(f => f.startsWith('quality-report-'))
                .sort()
                .reverse()[0];
              
              if (latestReport) {
                const reportPath = path.join(reportsDir, latestReport);
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                const comment = `
            ## ğŸ“Š RelatÃ³rio de Qualidade de CÃ³digo
            
            ### Resumo
            - **Status**: ${report.summary?.status || 'N/A'}
            - **Problemas encontrados**: ${report.summary?.totalIssues || 0}
            - **VerificaÃ§Ãµes**: ${report.summary?.passed || 0}/${report.summary?.checks || 0} passaram
            
            ### Detalhes
            ${report.summary?.recommendations?.map(rec => `- ${rec}`).join('\n') || 'Nenhuma recomendaÃ§Ã£o especÃ­fica.'}
            
            ### ESLint
            - **Erros**: ${report.eslint?.stats?.errors || 0}
            - **Avisos**: ${report.eslint?.stats?.warnings || 0}
            - **Problemas de seguranÃ§a**: ${report.eslint?.stats?.securityIssues || 0}
            
            ### Vulnerabilidades
            - **CrÃ­ticas**: ${report.vulnerabilities?.stats?.critical || 0}
            - **Total**: ${report.vulnerabilities?.stats?.total || 0}
            
            ### Complexidade
            - **FunÃ§Ãµes complexas**: ${report.complexity?.stats?.highComplexityFiles || 0}
            - **Complexidade mÃ©dia**: ${report.complexity?.stats?.averageComplexity || 'N/A'}
            
            ---
            *RelatÃ³rio gerado automaticamente pela verificaÃ§Ã£o de qualidade*
                `;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

  security-scan:
    name: VerificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Instalar dependÃªncias
        run: npm ci

      - name: Verificar secrets no cÃ³digo
        run: |
          # Buscar por padrÃµes de secrets comuns
          echo "ğŸ” Verificando vazamento de secrets..."
          
          # PadrÃµes de API keys
          if grep -r -E "(api[_-]?key|secret|password)\s*[:=]\s*['\"][a-zA-Z0-9]{20,}['\"]" --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" src/ server/ 2>/dev/null; then
            echo "âŒ PossÃ­vel vazamento de secrets detectado!"
            exit 1
          fi
          
          # PadrÃµes de URLs de banco de dados
          if grep -r -E "postgres://[^'\"]*:[^'\"]*@" --include="*.ts" --include="*.js" src/ server/ 2>/dev/null; then
            echo "âŒ String de conexÃ£o de banco detectada no cÃ³digo!"
            exit 1
          fi
          
          echo "âœ… Nenhum vazamento de secrets detectado"

      - name: Verificar dependÃªncias obsoletas
        run: |
          echo "ğŸ“¦ Verificando dependÃªncias obsoletas..."
          OUTDATED=$(npm outdated --json || echo '{}')
          CRITICAL_OUTDATED=$(echo "$OUTDATED" | jq 'to_entries | map(select(.value.current | split(".")[0] != .value.wanted | split(".")[0])) | length')
          
          if [ "$CRITICAL_OUTDATED" -gt 0 ]; then
            echo "âš ï¸ $CRITICAL_OUTDATED dependÃªncias com major versions desatualizadas"
            echo "$OUTDATED" | jq -r 'to_entries[] | select(.value.current | split(".")[0] != .value.wanted | split(".")[0]) | "- \(.key): \(.value.current) â†’ \(.value.wanted)"'
          else
            echo "âœ… Todas as dependÃªncias estÃ£o atualizadas"
          fi

      - name: AnÃ¡lise de licenÃ§as
        run: |
          echo "ğŸ“„ Verificando licenÃ§as das dependÃªncias..."
          npx license-checker --summary --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0" || echo "âš ï¸ Algumas dependÃªncias podem ter licenÃ§as restritivas"